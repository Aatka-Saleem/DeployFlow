# Security Rules for DeployFlow Security Agent
# These rules will be checked against generated Dockerfiles and configurations

security_rules:
  # CRITICAL SEVERITY RULES
  - rule_id: SEC001
    name: no_hardcoded_secrets
    severity: CRITICAL
    description: "Hardcoded secrets detected in Dockerfile"
    pattern: "(PASSWORD|API_KEY|SECRET|TOKEN)\\s*=\\s*['\"]?[a-zA-Z0-9]+"
    applies_to: [dockerfile]
    message: "Hardcoded secrets found. Use environment variables or secrets management instead."
    
  - rule_id: SEC002
    name: no_root_user
    severity: CRITICAL
    description: "Container running as root user"
    pattern: "^(?!.*USER\\s+(?!root))"
    applies_to: [dockerfile]
    message: "Container should not run as root. Add non-root user."
    fix_suggestion: "Add: RUN useradd -m appuser && USER appuser"
    
  - rule_id: SEC003
    name: exposed_sensitive_ports
    severity: CRITICAL
    description: "Sensitive ports exposed"
    pattern: "EXPOSE\\s+(22|3306|5432|27017|6379)"
    applies_to: [dockerfile]
    message: "Sensitive database or SSH ports should not be exposed."

  # HIGH SEVERITY RULES
  - rule_id: SEC004
    name: latest_tag_usage
    severity: HIGH
    description: "Using :latest tag in FROM instruction"
    pattern: "FROM\\s+[^:]+:latest"
    applies_to: [dockerfile]
    message: "Avoid using :latest tag. Use specific version tags."
    fix_suggestion: "Use specific version: FROM python:3.11-slim instead of FROM python:latest"
    
  - rule_id: SEC005
    name: privilege_escalation
    severity: HIGH
    description: "Privilege escalation allowed"
    pattern: "allowPrivilegeEscalation:\\s*true"
    applies_to: [kubernetes]
    message: "Privilege escalation should be disabled in production."
    fix_suggestion: "Set allowPrivilegeEscalation: false"
    
  - rule_id: SEC006
    name: missing_resource_limits
    severity: HIGH
    description: "No resource limits defined"
    pattern: "^(?!.*limits:)"
    applies_to: [kubernetes]
    message: "Resource limits should be defined to prevent resource exhaustion."
    fix_suggestion: "Add resource limits for CPU and memory"

  # MEDIUM SEVERITY RULES
  - rule_id: SEC007
    name: missing_health_check
    severity: MEDIUM
    description: "No health check defined"
    pattern: "^(?!.*HEALTHCHECK)"
    applies_to: [dockerfile]
    message: "Health checks help with reliability and orchestration."
    fix_suggestion: "Add HEALTHCHECK instruction"
    
  - rule_id: SEC008
    name: writable_root_filesystem
    severity: MEDIUM
    description: "Root filesystem is writable"
    pattern: "readOnlyRootFilesystem:\\s*false"
    applies_to: [kubernetes]
    message: "Consider using read-only root filesystem when possible."
    
  - rule_id: SEC009
    name: no_version_pinning
    severity: MEDIUM
    description: "Dependencies not version-pinned"
    applies_to: [requirements, package.json]
    message: "Pin dependency versions for reproducible builds."

  # LOW SEVERITY / BEST PRACTICE RULES
  - rule_id: SEC010
    name: large_base_image
    severity: LOW
    description: "Using full base image instead of slim/alpine"
    pattern: "FROM\\s+(python|node):[\\d.]+(\\s|$)"
    applies_to: [dockerfile]
    message: "Consider using slim or alpine variants for smaller image size."
    fix_suggestion: "Use python:3.11-slim or node:18-alpine"
    
  - rule_id: SEC011
    name: apt_cache_not_cleaned
    severity: LOW
    description: "apt cache not cleaned after install"
    pattern: "apt-get install.*\\n(?!.*rm -rf /var/lib/apt/lists)"
    applies_to: [dockerfile]
    message: "Clean apt cache to reduce image size."
    fix_suggestion: "Add: && rm -rf /var/lib/apt/lists/*"
    
  - rule_id: SEC012
    name: missing_dockerignore
    severity: LOW
    description: ".dockerignore file missing"
    applies_to: [project]
    message: "Create .dockerignore to exclude unnecessary files."

best_practices:
  dockerfile:
    - "Use multi-stage builds to reduce final image size"
    - "Order instructions from least to most frequently changed"
    - "Combine RUN commands to reduce layers"
    - "Use COPY instead of ADD unless you need tar extraction"
    - "Don't install unnecessary packages"
    
  kubernetes:
    - "Always set resource requests and limits"
    - "Use liveness and readiness probes"
    - "Run multiple replicas for high availability"
    - "Use secrets for sensitive data, not ConfigMaps"
    - "Implement network policies for segmentation"
    
  cicd:
    - "Scan images for vulnerabilities before deployment"
    - "Run tests before building containers"
    - "Use secrets management for credentials"
    - "Implement automated rollback on failure"
    - "Tag images with commit SHA for traceability"

compliance_checks:
  production_ready:
    - name: "Non-root user"
      check: "USER instruction present and not root"
      required: true
    
    - name: "Specific image tags"
      check: "No :latest tags in FROM"
      required: true
    
    - name: "Resource limits"
      check: "CPU and memory limits defined"
      required: true
    
    - name: "Health checks"
      check: "Liveness and readiness probes configured"
      required: true
    
    - name: "No hardcoded secrets"
      check: "No API keys, passwords in code"
      required: true
    
    - name: "Security context"
      check: "runAsNonRoot: true, allowPrivilegeEscalation: false"
      required: true
    
    - name: "Minimum replicas"
      check: "At least 2 replicas for HA"
      required: false
    
    - name: "Auto-scaling configured"
      check: "HPA defined with appropriate thresholds"
      required: false